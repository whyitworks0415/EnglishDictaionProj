<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë“£ê¸° ìˆ˜í–‰í‰ê°€ ì—°ìŠµê¸°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* 1. ê¸°ë³¸ & ë¯¸ë‹ˆë©€ë¦¬ì¦˜ ìŠ¤íƒ€ì¼ */
        :root {
            --bg-color: #ffffff;
            --text-color: #222222;
            --border-color: #eeeeee;
            --highlight-bg: #fff0a0;
            --vocab-bg: #d0f0ff;
            --correct-color: #008000;
            --incorrect-color: #d00000;
            --button-bg: #f5f5f5;
            --button-hover-bg: #e0e0e0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
                Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }

        /* 2. ë‹¤í¬ ëª¨ë“œ */
        body.dark-mode {
            --bg-color: #222222;
            --text-color: #eeeeee;
            --border-color: #444444;
            --highlight-bg: #5a5000;
            --vocab-bg: #003a5c;
            --button-bg: #333333;
            --button-hover-bg: #555555;
        }

        /* 3. ë ˆì´ì•„ì›ƒ ë° ê³µí†µ ì»´í¬ë„ŒíŠ¸ */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        button,
        input[type="number"],
        select {
            font-size: 1rem;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            background-color: var(--button-bg);
            color: var(--text-color);
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: background-color 0.2s;
        }
        
        input[type="file"] {
            font-size: 0.95rem;
            border: 1px solid var(--border-color);
            background-color: var(--button-bg);
            color: var(--text-color);
            border-radius: 5px;
            padding: 5px;
            width: 100%;
            box-sizing: border-box; /* paddingì´ ë„ˆë¹„ì— í¬í•¨ë˜ë„ë¡ */
        }


        button:hover {
            background-color: var(--button-hover-bg);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        header {
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 20px;
            margin-bottom: 20px;
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .view {
            display: none; /* ë·°ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
        }
        .view.active {
            display: block; /* í™œì„±í™”ëœ ë·°ë§Œ ë³´ì„ */
        }

        audio {
            width: 100%;
            margin-top: 20px;
        }

        /* [ìˆ˜ì •ë¨] íŒŒì¼ ë¡œë” UI/UX ê°œì„  */
        .file-loader {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            background-color: var(--button-bg);
        }
        .file-input-group {
            margin: 12px 0;
        }
        .file-input-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
        }
        body.dark-mode .file-loader {
            background-color: #333;
        }


        /* 4. ìŠ¤í¬ë¦½íŠ¸ ë·° ìŠ¤íƒ€ì¼ */
        #script-list p {
            padding: 10px;
            border-bottom: 1px dashed var(--border-color);
            cursor: pointer;
        }
        #script-list p:hover {
            background-color: var(--button-bg);
        }
        #script-list p .time {
            font-size: 0.8em;
            color: #888;
            margin-right: 10px;
            display: inline-block;
            width: 90px;
        }
        #script-list p .sentence span {
            padding: 2px 0;
            border-radius: 3px;
        }

        /* 5. í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼ */
        .sentence span.highlighted {
            background-color: var(--highlight-bg);
        }
        .sentence span.vocab {
            background-color: var(--vocab-bg);
            border-radius: 3px;
            font-weight: 500;
        }

        /* 6. ëª¨ì˜ í…ŒìŠ¤íŠ¸ ë·° ìŠ¤íƒ€ì¼ */
        .test-controls {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            margin-bottom: 20px;
        }

        #test-content .sentence {
            margin-bottom: 15px;
            line-height: 2;
        }

        .hax-input {
            border: none;
            border-bottom: 1.5px solid var(--text-color);
            background-color: transparent;
            color: var(--text-color);
            font: inherit;
            text-align: center;
            padding: 2px 4px;
            min-width: 60px;
            margin: 0 2px;
        }
        .hax-input::placeholder {
            color: #999;
            opacity: 0.6;
        }
        .hax-input-group {
            display: inline-block;
            margin: 0 4px;
        }
        
        /* ì±„ì  ê²°ê³¼ */
        .test-result {
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 600;
        }
        .test-result.correct {
            color: var(--correct-color);
            background-color: #e0ffe0;
        }
        .test-result.incorrect {
            color: var(--incorrect-color);
            background-color: #ffe0e0;
            text-decoration: line-through;
        }
        /* ë‹¤í¬ëª¨ë“œ ì±„ì  ê²°ê³¼ */
        body.dark-mode .test-result.correct {
            background-color: #004d00;
        }
        body.dark-mode .test-result.incorrect {
            background-color: #4d0000;
        }

    </style>
</head>
<body>

    <div class="container">
        <header>
            <h3>ë“£ê¸° ì—°ìŠµ í”„ë¡œê·¸ë¨</h3>
            <div class="file-loader">
                <p><strong>íŒŒì¼ 3ê°œë¥¼ ë¡œë“œí•˜ì„¸ìš”:</strong></p>
                <div class="file-input-group">
                    <label for="mp3-file">ğŸ§ ì˜¤ë””ì˜¤ íŒŒì¼ (ListeningFile.mp3)</label>
                    <input type="file" id="mp3-file" accept="audio/mpeg">
                </div>
                <div class="file-input-group">
                    <label for="script-file">ğŸ“ ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ (Script.xlsx)</label>
                    <input type="file" id="script-file" accept=".xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
                </div>
                <div class="file-input-group">
                    <label for="vocab-file">ğŸ“š ë‹¨ì–´ íŒŒì¼ (Vocab.xlsx)</label>
                    <input type="file" id="vocab-file" accept=".xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
                </div>
            </div>
            <nav>
                <div>
                    <button id="nav-script">ìŠ¤í¬ë¦½íŠ¸ ë³´ê¸°</button>
                    <button id="nav-test">ëª¨ì˜ í…ŒìŠ¤íŠ¸</button>
                </div>
                <div>
                    <button id="toggle-vocab">ë‹¨ì–´ í•˜ì´ë¼ì´íŠ¸</button>
                    <button id="toggle-dark">ë‹¤í¬ ëª¨ë“œ</button>
                </div>
            </nav>
            <audio id="audio-player" controls></audio>
        </header>

        <div id="script-view" class="view active">
            <h2>ìŠ¤í¬ë¦½íŠ¸</h2>
            <div id="script-list">
                <p>íŒŒì¼ì„ ë¨¼ì € ë¡œë“œí•´ì£¼ì„¸ìš”...</p>
            </div>
        </div>

        <div id="test-view" class="view">
            <h2>ëª¨ì˜ í…ŒìŠ¤íŠ¸</h2>
            <div class="test-controls">
                <label for="hax-count">hax (ë¹ˆì¹¸) ê°œìˆ˜:</label>
                <input type="number" id="hax-count" value="10" min="1">
                <button id="start-test-btn">í…ŒìŠ¤íŠ¸ ì‹œì‘</button>
            </div>
            
            <div class="test-audio-controls">
                <button id="play-test-btn" disabled>ì „ì²´ ë“£ê¸° (2íšŒ ë‚¨ìŒ)</button>
                <button id="check-test-btn" disabled>ì±„ì í•˜ê¸°</button>
            </div>
            <div id="test-content">
                <p>í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•˜ì„¸ìš”.</p>
            </div>
        </div>

    </div>

    <script>
        // --- 1. ì „ì—­ ë³€ìˆ˜ ë° ìƒíƒœ ---
        let scriptData = []; // {startTime, endTime, text, rawText}
        let vocabData = new Set(); // { "word1", "word2" }
        let highlights = {}; // { sIdx_wIdx: true }
        let audioPlayer = document.getElementById('audio-player');
        let audioFile = null;

        let testPlayCount = 0;
        const MAX_TEST_PLAYS = 2;
        let testAnswers = []; // { answer, inputs: [input1, input2, ...] }

        // --- 2. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---

        // (CSV íŒŒì„œ ì‚­ì œë¨)

        // ì‹œê°„(MM:SS.s ë˜ëŠ” SS.s)ì„ ì´ˆ(float)ë¡œ ë³€í™˜
        function timeToSeconds(timeStr) {
            if (typeof timeStr !== 'string' && typeof timeStr !== 'number') {
                console.error('Invalid time value:', timeStr);
                return 0;
            }
            const timeStrClean = String(timeStr).trim();
            const parts = timeStrClean.split(':');
            
            if (parts.length > 1) {
                // "MM:SS.s" í˜•ì‹
                const minutes = parseFloat(parts[0]);
                const seconds = parseFloat(parts[1]);
                if (isNaN(minutes) || isNaN(seconds)) return 0;
                return (minutes * 60) + seconds;
            } else {
                // "SS.s" í˜•ì‹
                const seconds = parseFloat(parts[0]);
                if (isNaN(seconds)) return 0;
                return seconds;
            }
        }

        // ë‹¨ì–´ ì •ë¦¬ (í•˜ì´ë¼ì´íŠ¸ ë° ë¹„êµìš©)
        function cleanWord(word) {
            return word.toLowerCase().replace(/^[.,?"'!]*/, '').replace(/[.,?"'!]*$/, '');
        }

        // ì²´ì ìš© ë‹¨ì–´ ì •ë¦¬ (ì‰¼í‘œ ì™„ì „ ì œê±°)
        function cleanWordForScoring(word) {
            return word.toLowerCase().replace(/,/g, '').replace(/^[.,?"'!]*/, '').replace(/[.,?"'!]*$/, '').trim();
        }

        // ë¹ˆì¹¸ í›„ë³´ì—ì„œ ì œì™¸í•  ë‹¨ì–´ì¸ì§€ í™•ì¸
        function shouldExcludeFromHax(word, isFirstWordInSentence = false) {
            const cleaned = cleanWord(word);
            const wordWithoutPunctuation = word.replace(/[.,?"'!]*$/, '');
            
            // 1. ìˆ«ì ì²´í¬ (ìˆœìˆ˜ ìˆ«ì ë˜ëŠ” ì†Œìˆ˜ì  í¬í•¨ ìˆ«ì)
            if (/^\d+$/.test(cleaned) || /^\d+[.,]\d+$/.test(cleaned)) {
                return true;
            }
            
            // 2. ê³ ìœ ëª…ì‚¬/ì´ë¦„ ì²´í¬ (ì²« ê¸€ìê°€ ëŒ€ë¬¸ìì´ê³  ë¬¸ì¥ ì‹œì‘ì´ ì•„ë‹Œ ê²½ìš°)
            // ëª¨ë“  ê¸€ìê°€ ëŒ€ë¬¸ìì¸ ê²½ìš°ëŠ” ì•½ì–´ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì œì™¸í•˜ì§€ ì•ŠìŒ
            // ì´ë¦„ íŒ¨í„´: ì²« ê¸€ìê°€ ëŒ€ë¬¸ìì´ê³  ë‚˜ë¨¸ì§€ê°€ ì†Œë¬¸ì (ì˜ˆ: Trisdale, John, Mary)
            if (!isFirstWordInSentence && /^[A-Z]/.test(word)) {
                // ì²« ê¸€ì ëŒ€ë¬¸ì + ë‚˜ë¨¸ì§€ ì†Œë¬¸ì íŒ¨í„´ (ì´ë¦„ íŒ¨í„´)
                if (/^[A-Z][a-z]+$/.test(wordWithoutPunctuation)) {
                    return true;
                }
            }
            
            // 3. ë‹¤ë¥¸ ì–¸ì–´ ì²´í¬ (ì˜ì–´ ì•ŒíŒŒë²³ì´ ì•„ë‹Œ ë¬¸ìê°€ í¬í•¨ëœ ê²½ìš°)
            // ì˜ì–´ ì•ŒíŒŒë²³, ìˆ«ì, ê¸°ë³¸ êµ¬ë‘ì ë§Œ í—ˆìš©
            const englishPattern = /^[a-zA-Z0-9.,?"'!\- ]+$/;
            if (!englishPattern.test(word)) {
                return true;
            }
            
            // 4. ì˜ì–´ ì•ŒíŒŒë²³ì´ ì „í˜€ ì—†ëŠ” ê²½ìš° (ìˆ«ìë‚˜ êµ¬ë‘ì ë§Œ ìˆëŠ” ê²½ìš°)
            if (!/[a-zA-Z]/.test(word)) {
                return true;
            }
            
            return false;
        }

        // [ì¶”ê°€ë¨] Pythonì˜ simple_stemì„ JSë¡œ êµ¬í˜„
        function simpleStem(word) {
            let w = cleanWord(word);
            if (w.length < 3) return w;

            if (w.endsWith("'s")) w = w.slice(0, -2);
            
            if (w.endsWith("s") && !w.endsWith("ss")) {
                if (w.endsWith("ies")) return w.slice(0, -3) + 'y';
                if (w.endsWith("es")) {
                    if (w.length > 4 && "aeiou".indexOf(w.slice(-3, -2)) === -1) {
                         return w.slice(0, -2);
                    }
                    return w.slice(0,-1);
                }
                if (w.length > 3) return w.slice(0, -1);
            }
            
            const suffixes = ['ing', 'ed', 'er', 'est', 'ly', 'ment', 'ness', 'ation', 'able', 'ible'];
            for (const suf of suffixes) {
                if (w.endsWith(suf) && w.length - suf.length >= 3) {
                    if (suf === 'ing' && w.length > 4 && w.slice(-4,-3) === w.slice(-5,-4)) {
                        return w.slice(0,-4);
                    }
                    if (suf === 'ed' && w.length > 4 && w.slice(-3,-2) === w.slice(-4,-3)) {
                        return w.slice(0,-3);
                    }
                    return w.slice(0, -suf.length);
                }
            }
            return w;
        }

        // --- 3. íŒŒì¼ ë¡œë”© ---

        document.getElementById('mp3-file').addEventListener('change', (e) => {
            audioFile = e.target.files[0];
            audioPlayer.src = URL.createObjectURL(audioFile);
            checkFilesLoaded();
        });

        // [ìˆ˜ì •ë¨] XLSX íŒŒì¼ ë¦¬ë”ë¡œ ë³€ê²½
        document.getElementById('script-file').addEventListener('change', (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    loadScript(json);
                    checkFilesLoaded();
                } catch (err) {
                    console.error("Error reading script file:", err);
                    alert("ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼(Script.xlsx)ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // [ìˆ˜ì •ë¨] XLSX íŒŒì¼ ë¦¬ë”ë¡œ ë³€ê²½
        document.getElementById('vocab-file').addEventListener('change', (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    loadVocab(json);
                    checkFilesLoaded();
                } catch (err) {
                    console.error("Error reading vocab file:", err);
                    alert("ë‹¨ì–´ íŒŒì¼(Vocab.xlsx)ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // [ìˆ˜ì •ë¨] CSV íŒŒì‹± ëŒ€ì‹  XLSX JSON ë°ì´í„°ë¥¼ ì²˜ë¦¬
        function loadScript(data) {
            // dataëŠ” [["Start Time", "End Time", "Text"], ["0:01.4", "0:02.4", "The cactus."]] í˜•íƒœ
            scriptData = data
                .slice(1) // í—¤ë” í–‰ ì œê±°
                .filter(row => row && row.length >= 3 && row[0] && row[1] && row[2]) // ìœ íš¨í•œ ë°ì´í„° í•„í„°ë§
                .map(row => ({
                    startTime: String(row[0]).trim(),
                    endTime: String(row[1]).trim(),
                    text: String(row[2]).trim().replace(/"/g, ''),
                    rawText: String(row[2]).trim().replace(/"/g, '')
                }));
        }

        // [ìˆ˜ì •ë¨] CSV íŒŒì‹± ëŒ€ì‹  XLSX JSON ë°ì´í„°ë¥¼ ì²˜ë¦¬ + simpleStem ì ìš©
        function loadVocab(data) {
            // dataëŠ” [["English Word", "Meaning"], ["cactus", "ì„ ì¸ì¥"]] í˜•íƒœ
            vocabData.clear();
            data.slice(1) // í—¤ë” í–‰ ì œê±°
                .forEach(row => {
                    if (row && row[0]) {
                        vocabData.add(simpleStem(String(row[0]).trim()));
                    }
                });
        }
        
        function checkFilesLoaded() {
            if (audioFile && scriptData.length > 0 && vocabData.size > 0) {
                alert('ëª¨ë“  íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
                // hax-countì˜ maxë¥¼ ë¬¸ì¥ ìˆ˜ë¡œ ì„¤ì •
                const haxCountInput = document.getElementById('hax-count');
                haxCountInput.max = scriptData.length;
                if (parseInt(haxCountInput.value, 10) > scriptData.length) {
                    haxCountInput.value = scriptData.length;
                }
                displayScript();
            }
        }

        // --- 4. ë·° ìŠ¤í¬ë¦½íŒ… (ìŠ¤í¬ë¦½íŠ¸ ë³´ê¸°) ---

        function displayScript() {
            const scriptList = document.getElementById('script-list');
            scriptList.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”
            loadHighlights(); // ì €ì¥ëœ í•˜ì´ë¼ì´íŠ¸ ë¡œë“œ

            scriptData.forEach((sentence, sIdx) => {
                const p = document.createElement('p');
                p.dataset.sIdx = sIdx;

                // ì‹œê°„ í‘œì‹œ
                const timeSpan = document.createElement('span');
                timeSpan.className = 'time';
                timeSpan.textContent = `(${sentence.startTime} - ${sentence.endTime})`;
                
                // ë¬¸ì¥ í‘œì‹œ (ë‹¨ì–´ë³„ <span>ìœ¼ë¡œ ë¶„ë¦¬)
                const sentenceSpan = document.createElement('span');
                sentenceSpan.className = 'sentence';
                sentenceSpan.dataset.sIdx = sIdx;

                const words = sentence.text.split(/(\s+)/); // ê³µë°±ì„ í¬í•¨í•˜ì—¬ ë¶„ë¦¬
                words.forEach((word, wIdx) => {
                    if (word.trim().length > 0) {
                        const wordSpan = document.createElement('span');
                        wordSpan.textContent = word;
                        wordSpan.dataset.wIdx = wIdx;
                        
                        // ì €ì¥ëœ í•˜ì´ë¼ì´íŠ¸ ì ìš©
                        if (highlights[`${sIdx}_${wIdx}`]) {
                            wordSpan.classList.add('highlighted');
                        }
                        sentenceSpan.appendChild(wordSpan);
                    } else {
                        sentenceSpan.appendChild(document.createTextNode(word));
                    }
                });

                p.appendChild(timeSpan);
                p.appendChild(sentenceSpan);

                // ë¬¸ì¥ í´ë¦­ ì‹œ ì˜¤ë””ì˜¤ ì¬ìƒ
                p.addEventListener('click', (e) => {
                    // ë‹¨ì–´ í•˜ì´ë¼ì´íŠ¸ ë¡œì§
                    if (e.target.tagName === 'SPAN' && e.target.dataset.wIdx) {
                        toggleHighlight(sIdx, e.target.dataset.wIdx);
                        e.target.classList.toggle('highlighted');
                    } else {
                        // ë¬¸ì¥ ì¬ìƒ ë¡œì§
                        playSegment(sIdx);
                    }
                });
                scriptList.appendChild(p);
            });
        }
        
        let stopAudioTimer = null;
        function playSegment(sIdx) {
            if (stopAudioTimer) {
                clearTimeout(stopAudioTimer);
                stopAudioTimer = null;
            }
            
            const sentence = scriptData[sIdx];
            const start = timeToSeconds(sentence.startTime);
            const end = timeToSeconds(sentence.endTime);
            
            if (isNaN(start) || isNaN(end)) {
                alert('ìŠ¤í¬ë¦½íŠ¸ì˜ ì‹œê°„ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤. (ì˜ˆ: 0:01.4)');
                return;
            }

            audioPlayer.currentTime = start;
            audioPlayer.play();

            stopAudioTimer = setTimeout(() => {
                audioPlayer.pause();
            }, (end - start) * 1000);
        }

        // --- 5. í•˜ì´ë¼ì´íŠ¸ ê¸°ëŠ¥ ---

        function toggleHighlight(sIdx, wIdx) {
            const key = `${sIdx}_${wIdx}`;
            if (highlights[key]) {
                delete highlights[key];
            } else {
                highlights[key] = true;
            }
            saveHighlights();
        }

        function saveHighlights() {
            localStorage.setItem('scriptHighlights', JSON.stringify(highlights));
        }

        function loadHighlights() {
            highlights = JSON.parse(localStorage.getItem('scriptHighlights')) || {};
        }

        // [ìˆ˜ì •ë¨] ë‹¨ì–´ í•˜ì´ë¼ì´íŠ¸ í† ê¸€ (simpleStem ì ìš©)
        document.getElementById('toggle-vocab').addEventListener('click', () => {
            const scriptList = document.getElementById('script-list');
            const isToggled = scriptList.classList.toggle('vocab-toggled');
            
            document.querySelectorAll('#script-list .sentence span[data-w-idx]').forEach(span => {
                if (isToggled) {
                    const word = simpleStem(span.textContent);
                    if (vocabData.has(word)) {
                        span.classList.add('vocab');
                    }
                } else {
                    span.classList.remove('vocab');
                }
            });
        });

        // --- 6. ë·° ìŠ¤í¬ë¦½íŒ… (ëª¨ì˜ í…ŒìŠ¤íŠ¸) ---
        
        document.getElementById('start-test-btn').addEventListener('click', startTest);
        document.getElementById('play-test-btn').addEventListener('click', playTestAudio);
        document.getElementById('check-test-btn').addEventListener('click', checkTest);

        function startTest() {
            const haxCount = parseInt(document.getElementById('hax-count').value, 10);
            const maxHaxCount = scriptData.length; // ë¬¸ì¥ ìˆ˜ë§Œí¼ìœ¼ë¡œ ì œí•œ
            
            if (haxCount <= 0 || scriptData.length === 0) {
                alert('hax ê°œìˆ˜ë¥¼ 1 ì´ìƒìœ¼ë¡œ ì„¤ì •í•˜ê±°ë‚˜ íŒŒì¼ì„ ë¨¼ì € ë¡œë“œí•˜ì„¸ìš”.');
                return;
            }
            
            if (haxCount > maxHaxCount) {
                alert(`hax ê°œìˆ˜ëŠ” ë¬¸ì¥ ìˆ˜(${maxHaxCount}ê°œ)ë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                document.getElementById('hax-count').value = maxHaxCount;
                return;
            }

            // 1. ëª¨ë“  ë‹¨ì–´ ë¦¬ìŠ¤íŠ¸ ìƒì„±
            const allWords = [];
            scriptData.forEach((sentence, sIdx) => {
                const words = sentence.rawText.split(' ');
                words.forEach((word, wIdx) => {
                    allWords.push({ sIdx, wIdx, word, isFirstWord: wIdx === 0 });
                });
            });

            // 2. ë¹ˆì¹¸ í›„ë³´ ì„ ì • (vocab ìš°ì„ , ë¬¸ì¥ë³„ë¡œ ê·¸ë£¹í™”, ì œì™¸ ë‹¨ì–´ í•„í„°ë§)
            const vocabCandidates = []; // {sIdx, wordIndex}
            const otherCandidates = []; // {sIdx, wordIndex}
            
            allWords.forEach((word, index) => {
                // ì œì™¸í•  ë‹¨ì–´ëŠ” ë¹ˆì¹¸ í›„ë³´ì—ì„œ ì œì™¸
                if (shouldExcludeFromHax(word.word, word.isFirstWord)) {
                    return;
                }
                
                const candidate = { sIdx: word.sIdx, wordIndex: index };
                if (vocabData.has(cleanWord(word.word))) {
                    vocabCandidates.push(candidate);
                } else {
                    otherCandidates.push(candidate);
                }
            });
            
            // 3. í›„ë³´ ì„ê¸°
            const shuffledVocab = vocabCandidates.sort(() => 0.5 - Math.random());
            const shuffledOther = otherCandidates.sort(() => 0.5 - Math.random());
            
            const allCandidates = [
                ...shuffledVocab,
                ...shuffledOther
            ];

            // 4. Hax ë°ì´í„° ìƒì„± (í•œ ë¬¸ì¥ë‹¹ ìµœëŒ€ 1ê°œ ë¹ˆì¹¸)
            const haxData = []; // {sIdx, wIdx, length, answer}
            const usedWordIndices = new Set();
            const usedSentences = new Set(); // ì´ë¯¸ ë¹ˆì¹¸ì´ ìˆëŠ” ë¬¸ì¥ ì¶”ì 
            
            for (const candidate of allCandidates) {
                if (haxData.length >= haxCount) break;
                
                // ì´ë¯¸ ë¹ˆì¹¸ì´ ìˆëŠ” ë¬¸ì¥ì€ ê±´ë„ˆë›°ê¸°
                if (usedSentences.has(candidate.sIdx)) continue;
                
                const wordIndex = candidate.wordIndex;
                if (usedWordIndices.has(wordIndex)) continue;

                const haxLength = Math.floor(Math.random() * 3) + 1; // 1~3 ë‹¨ì–´
                const startWord = allWords[wordIndex];
                
                let answerWords = [];
                let isValidHax = true;
                
                for (let i = 0; i < haxLength; i++) {
                    const currentWordIndex = wordIndex + i;
                    if (currentWordIndex >= allWords.length || 
                        usedWordIndices.has(currentWordIndex) ||
                        allWords[currentWordIndex].sIdx !== startWord.sIdx) { // ë¬¸ì¥ ë„˜ê¹€ ë°©ì§€
                        isValidHax = false;
                        break;
                    }
                    
                    // ë¹ˆì¹¸ì— í¬í•¨ë  ë‹¨ì–´ë„ ì œì™¸ ë‹¨ì–´ê°€ ì•„ë‹Œì§€ í™•ì¸
                    const currentWord = allWords[currentWordIndex];
                    if (shouldExcludeFromHax(currentWord.word, currentWord.isFirstWord)) {
                        isValidHax = false;
                        break;
                    }
                    
                    answerWords.push(allWords[currentWordIndex].word);
                    usedWordIndices.add(currentWordIndex);
                }

                if (isValidHax) {
                    haxData.push({
                        sIdx: startWord.sIdx,
                        wIdx: startWord.wIdx,
                        length: haxLength,
                        answer: answerWords.join(' ')
                    });
                    usedSentences.add(startWord.sIdx); // ì´ ë¬¸ì¥ì— ë¹ˆì¹¸ì´ ìˆìŒì„ í‘œì‹œ
                }
            }
            
            // 5. í…ŒìŠ¤íŠ¸ í™”ë©´ ë Œë”ë§
            displayTestScript(haxData);
        }

        function displayTestScript(haxData) {
            const testContent = document.getElementById('test-content');
            testContent.innerHTML = '';
            testAnswers = []; // ì´ì „ ë‹µì•ˆ ì´ˆê¸°í™”

            const haxMap = {}; // sIdx ë¥¼ í‚¤ë¡œ hax ë°°ì—´ì„ ì €ì¥
            haxData.forEach(hax => {
                if (!haxMap[hax.sIdx]) {
                    haxMap[hax.sIdx] = [];
                }
                haxMap[hax.sIdx].push(hax);
            });
            // wIdx ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ (ì¤‘ìš”)
            for (const sIdx in haxMap) {
                haxMap[sIdx].sort((a, b) => a.wIdx - b.wIdx);
            }

            scriptData.forEach((sentence, sIdx) => {
                const p = document.createElement('p');
                p.className = 'sentence';
                
                if (!haxMap[sIdx]) {
                    p.textContent = sentence.rawText; // ë¹ˆì¹¸ ì—†ëŠ” ë¬¸ì¥
                } else {
                    const words = sentence.rawText.split(' ');
                    const haxInSentence = haxMap[sIdx];
                    let currentWordIndex = 0;
                    
                    while (currentWordIndex < words.length) {
                        const hax = haxInSentence.find(h => h.wIdx === currentWordIndex);
                        if (hax) {
                            // ë¹ˆì¹¸ ê·¸ë£¹ ìƒì„± (ë‹¨ì–´ ìˆ˜ë§Œí¼ ë°‘ì¤„ input ìƒì„±)
                            const haxGroup = document.createElement('span');
                            haxGroup.className = 'hax-input-group';
                            
                            const inputs = [];
                            for (let i = 0; i < hax.length; i++) {
                                const input = document.createElement('input');
                                input.type = 'text';
                                input.className = 'hax-input';
                                input.placeholder = '___';
                                
                                // Space í‚¤ë¡œ ë‹¤ìŒ ì¹¸ìœ¼ë¡œ ì´ë™
                                input.addEventListener('keydown', (e) => {
                                    if (e.key === ' ' || e.key === 'Space') {
                                        e.preventDefault();
                                        const currentIndex = inputs.indexOf(input);
                                        if (currentIndex < inputs.length - 1) {
                                            inputs[currentIndex + 1].focus();
                                        }
                                    }
                                });
                                
                                inputs.push(input);
                                haxGroup.appendChild(input);
                                
                                // ë§ˆì§€ë§‰ì´ ì•„ë‹ˆë©´ ê³µë°± ì¶”ê°€
                                if (i < hax.length - 1) {
                                    haxGroup.appendChild(document.createTextNode(' '));
                                }
                            }
                            
                            p.appendChild(haxGroup);
                            p.appendChild(document.createTextNode(' ')); // ë„ì–´ì“°ê¸°

                            testAnswers.push({ answer: hax.answer, inputs: inputs });
                            currentWordIndex += hax.length;
                        } else {
                            // ì¼ë°˜ ë‹¨ì–´
                            p.appendChild(document.createTextNode(words[currentWordIndex] + ' '));
                            currentWordIndex++;
                        }
                    }
                }
                testContent.appendChild(p);
            });
            
            // í…ŒìŠ¤íŠ¸ ìƒíƒœ ì´ˆê¸°í™”
            testPlayCount = 0;
            document.getElementById('play-test-btn').disabled = false;
            document.getElementById('play-test-btn').textContent = `ì „ì²´ ë“£ê¸° (${MAX_TEST_PLAYS - testPlayCount}íšŒ ë‚¨ìŒ)`;
            document.getElementById('check-test-btn').disabled = false;
        }

        function playTestAudio() {
            if (testPlayCount >= MAX_TEST_PLAYS) return;

            testPlayCount++;
            audioPlayer.currentTime = 0;
            audioPlayer.play();
            
            const remaining = MAX_TEST_PLAYS - testPlayCount;
            const playBtn = document.getElementById('play-test-btn');
            playBtn.textContent = `ì „ì²´ ë“£ê¸° (${remaining}íšŒ ë‚¨ìŒ)`;
            
            if (remaining <= 0) {
                playBtn.disabled = true;
            }
        }

        function checkTest() {
            if (testAnswers.length === 0) return;

            let correctCount = 0;
            testAnswers.forEach(item => {
                // ì—¬ëŸ¬ inputì˜ ê°’ì„ í•©ì³ì„œ ì‚¬ìš©ì ë‹µì•ˆ ìƒì„±
                const userInput = item.inputs.map(input => input.value.trim()).filter(v => v).join(' ');
                const correctAnswer = item.answer;

                // ì‰¼í‘œë¥¼ ì œì™¸í•œ ë¹„êµ
                const isCorrect = cleanWordForScoring(userInput) === cleanWordForScoring(correctAnswer);
                
                // ë¹ˆì¹¸ ê·¸ë£¹ì„ ê²°ê³¼ spanìœ¼ë¡œ êµì²´
                const haxGroup = item.inputs[0].parentNode;
                const resultSpan = document.createElement('span');
                resultSpan.className = 'test-result';
                resultSpan.textContent = userInput || '(ë¹ˆì¹¸)'; // ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê°’
                resultSpan.dataset.userAnswer = userInput || '(ë¹ˆì¹¸)';
                resultSpan.dataset.correctAnswer = correctAnswer;
                
                if (isCorrect) {
                    resultSpan.classList.add('correct');
                    correctCount++;
                } else {
                    resultSpan.classList.add('incorrect');
                    resultSpan.title = `ì •ë‹µ: ${correctAnswer}`; // ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ì •ë‹µ í‘œì‹œ
                    resultSpan.style.cursor = 'pointer'; // í´ë¦­ ê°€ëŠ¥ í‘œì‹œ
                    
                    // í´ë¦­ ì‹œ ì •ë‹µê³¼ ì˜¤ë‹µ êµì°¨ í‘œì‹œ
                    resultSpan.addEventListener('click', function() {
                        if (this.dataset.showingCorrect === 'true') {
                            this.textContent = this.dataset.userAnswer;
                            this.dataset.showingCorrect = 'false';
                        } else {
                            this.textContent = this.dataset.correctAnswer;
                            this.dataset.showingCorrect = 'true';
                        }
                    });
                }
                
                // haxGroupì„ ê²°ê³¼ spanìœ¼ë¡œ êµì²´
                haxGroup.parentNode.replaceChild(resultSpan, haxGroup);
            });
            
            alert(`ì±„ì  ì™„ë£Œ! ${testAnswers.length}ê°œ ì¤‘ ${correctCount}ê°œ ë§ì•˜ìŠµë‹ˆë‹¤.`);
            
            // ë²„íŠ¼ ë¹„í™œì„±í™” (ì¬ì±„ì  ë°©ì§€)
            document.getElementById('check-test-btn').disabled = true;
            document.getElementById('play-test-btn').disabled = true;
            
            // TODO: ì‹œí—˜ ê²°ê³¼ ì €ì¥ (localStorage)
        }

        // --- 7. ë„¤ë¹„ê²Œì´ì…˜ ë° ë‹¤í¬ ëª¨ë“œ ---

        function showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }

        document.getElementById('nav-script').addEventListener('click', () => showView('script-view'));
        document.getElementById('nav-test').addEventListener('click', () => showView('test-view'));

        // ë‹¤í¬ ëª¨ë“œ
        document.getElementById('toggle-dark').addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        });

        // --- 8. ì´ˆê¸°í™” ---
        function init() {
            // ë‹¤í¬ ëª¨ë“œ ì„¤ì • ë¡œë“œ
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
            }
            // í•˜ì´ë¼ì´íŠ¸ ë¡œë“œ (displayScriptì—ì„œ ì²˜ë¦¬)
            // ê¸°ë³¸ ë·° í™œì„±í™”
            showView('script-view');
        }

        init();

    </script>
</body>
</html>